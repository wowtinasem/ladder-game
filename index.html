<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÆ ÏÇ¨Îã§Î¶¨ ÌÉÄÍ∏∞ - Î≥¥Í∏ÄÎ≥¥Í∏Ä ÏóêÎîîÏÖò</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&display=swap');

  :root {
    --bg-dark: #1a0a2e;
    --neon-pink: #ff2d95;
    --neon-cyan: #00f0ff;
    --neon-yellow: #ffe600;
    --neon-green: #39ff14;
    --neon-orange: #ff6b00;
    --neon-purple: #bf00ff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-dark);
    font-family: 'Press Start 2P', 'DotGothic16', monospace;
    overflow-x: hidden;
    min-height: 100vh;
    color: #fff;
  }

  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.12) 2px, rgba(0,0,0,0.12) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
  .star {
    position: absolute; background: #fff; border-radius: 50%;
    animation: twinkle 2s infinite alternate;
  }
  @keyframes twinkle { 0% { opacity: 0.15; } 100% { opacity: 0.8; } }

  .container {
    position: relative; z-index: 1;
    max-width: 100%; width: 100%; margin: 0 auto; padding: 12px 20px;
  }

  .title-area { text-align: center; margin-bottom: 16px; animation: titleBounce 0.6s ease-out; }
  @keyframes titleBounce { 0%{transform:scale(0)} 60%{transform:scale(1.15)} 100%{transform:scale(1)} }
  .title-area h1 {
    font-size: 18px; color: var(--neon-yellow);
    text-shadow: 0 0 10px var(--neon-yellow), 0 0 30px var(--neon-yellow), 0 0 60px var(--neon-orange);
    letter-spacing: 2px; margin-bottom: 6px;
  }
  .title-area .subtitle { font-size: 8px; color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
  .coin-display { display: flex; justify-content: center; gap: 15px; margin-top: 8px; font-size: 7px; color: var(--neon-cyan); }
  .coin-display span { text-shadow: 0 0 5px var(--neon-cyan); }

  .game-board {
    background: linear-gradient(180deg, #0d0221 0%, #1a0a3e 30%, #150835 100%);
    border: 4px solid var(--neon-cyan);
    border-radius: 8px;
    box-shadow: 0 0 15px var(--neon-cyan), inset 0 0 30px rgba(0,240,255,0.05);
    padding: 18px 30px;
    position: relative; overflow: hidden;
  }

  .pixel-border {
    height: 6px;
    background: repeating-linear-gradient(90deg, var(--neon-pink) 0px, var(--neon-pink) 8px, var(--neon-cyan) 8px, var(--neon-cyan) 16px, var(--neon-yellow) 16px, var(--neon-yellow) 24px, var(--neon-green) 24px, var(--neon-green) 32px);
    border-radius: 3px; margin: 4px 0;
  }

  .row { display: flex; justify-content: space-around; position: relative; z-index: 2; }
  .char-slot { display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 140px; }
  .char-label { font-size: 8px; margin-bottom: 4px; color: #fff; font-weight: bold; text-shadow: 0 0 8px currentColor, 0 1px 2px rgba(0,0,0,0.8); }
  .character {
    width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
    font-size: 26px; border-radius: 6px; position: relative; transition: transform 0.3s; cursor: default;
  }
  .character:hover { transform: scale(1.15); }
  .character::after {
    content: ''; position: absolute; bottom: -5px; width: 28px; height: 5px;
    background: radial-gradient(ellipse, rgba(0,0,0,0.5) 0%, transparent 70%); border-radius: 50%;
  }

  .ladder-area { position: relative; height: 540px; margin: 10px 0; z-index: 2; }
  .ladder-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

  .mover {
    position: absolute; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    font-size: 20px; z-index: 10; filter: drop-shadow(0 0 6px rgba(255,255,255,0.7));
  }
  .mover.arrived { animation: arriveFlash 0.4s ease-out 4; }
  @keyframes arriveFlash { 0%,100%{filter:drop-shadow(0 0 6px rgba(255,255,255,0.7))} 50%{filter:drop-shadow(0 0 18px rgba(255,230,0,1)) brightness(1.5)} }

  .dest-slot { flex: 1; max-width: 140px; display: flex; flex-direction: column; align-items: center; }

  /* Arrived character display above the box */
  .dest-arrived {
    display: flex; flex-direction: column; align-items: center;
    min-height: 52px; justify-content: flex-end; margin-bottom: 4px;
    opacity: 0; transition: opacity 0.3s;
  }
  .dest-arrived.show {
    opacity: 1; animation: arriveCharPop 0.5s ease-out;
  }
  @keyframes arriveCharPop {
    0% { transform: scale(0) translateY(10px); opacity: 0; }
    60% { transform: scale(1.2) translateY(-3px); opacity: 1; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
  }
  .dest-arrived-emoji { font-size: 26px; line-height: 1; }
  .dest-arrived-name {
    font-size: 7px; margin-top: 2px; font-weight: bold;
    text-shadow: 0 0 6px currentColor, 0 1px 2px rgba(0,0,0,0.9);
    white-space: nowrap;
  }

  .dest-box {
    width: 48px; height: 48px; border: 3px solid #444; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; color: #555; background: rgba(0,0,0,0.4); position: relative; overflow: hidden;
  }
  .dest-box .qm { font-size: 18px; color: #666; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:0.35} 50%{opacity:1} }
  .dest-box.revealed { border-color: var(--neon-yellow); box-shadow: 0 0 15px var(--neon-yellow); animation: revealPop 0.4s ease-out; }
  @keyframes revealPop { 0%{transform:scale(0.5)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }
  .dest-box.revealed .rank { font-size: 22px; color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow); }
  .dest-box.revealed.r1 { border-color:#ffd700; box-shadow:0 0 25px #ffd700,0 0 50px rgba(255,215,0,0.3); }
  .dest-box.revealed.r1 .rank { color:#ffd700; }
  .dest-box.revealed.r2 { border-color:#c0c0c0; box-shadow:0 0 20px #c0c0c0; }
  .dest-box.revealed.r2 .rank { color:#c0c0c0; }
  .dest-box.revealed.r3 { border-color:#cd7f32; box-shadow:0 0 20px #cd7f32; }
  .dest-box.revealed.r3 .rank { color:#cd7f32; }
  .dest-label { font-size: 7px; margin-top: 4px; color: #888; }

  .controls { text-align: center; margin-top: 18px; }
  .start-btn {
    font-family: 'Press Start 2P', monospace; font-size: 15px; padding: 14px 38px;
    background: linear-gradient(180deg, #ff2d95, #cc0066); color: #fff;
    border: 4px solid #ff69b4; border-radius: 8px; cursor: pointer;
    text-shadow: 2px 2px 0 #990044;
    box-shadow: 0 6px 0 #990044, 0 0 20px rgba(255,45,149,0.4);
    transition: all 0.1s; letter-spacing: 2px;
  }
  .start-btn:hover { background: linear-gradient(180deg, #ff5cad, #dd1177); box-shadow: 0 6px 0 #990044, 0 0 30px rgba(255,45,149,0.6); }
  .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #990044, 0 0 20px rgba(255,45,149,0.4); }
  .start-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .blink { animation: blink 0.8s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  .result-banner {
    display: none; text-align: center; margin-top: 14px; padding: 14px;
    background: rgba(0,0,0,0.6); border: 2px solid var(--neon-green); border-radius: 8px;
    box-shadow: 0 0 20px rgba(57,255,20,0.3);
  }
  .result-banner.show { display: block; animation: slideUp 0.5s ease-out; }
  @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  .result-banner h2 { font-size: 13px; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); margin-bottom: 10px; }
  .result-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
  .result-item { display: flex; align-items: center; gap: 5px; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 8px; }
  .result-item .medal { font-size: 15px; }

  .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
  .confetti-piece { position: absolute; top: -10px; animation: confettiFall linear forwards; }
  @keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }

  @media (max-width: 768px) {
    .char-slot,.dest-slot { max-width: 80px; }
    .character { width: 36px; height: 36px; font-size: 20px; }
    .dest-box { width: 40px; height: 40px; }
    .dest-arrived-emoji { font-size: 22px; }
    .dest-arrived-name { font-size: 6px; }
    .dest-arrived { min-height: 44px; }
    .title-area h1 { font-size: 13px; }
    .ladder-area { height: 400px; }
    .start-btn { font-size: 11px; padding: 11px 26px; }
  }
  @media (max-width: 500px) {
    .char-slot,.dest-slot { max-width: 50px; }
    .character { width: 30px; height: 30px; font-size: 16px; }
    .dest-box { width: 34px; height: 34px; font-size: 16px; }
    .dest-arrived-emoji { font-size: 18px; }
    .dest-arrived-name { font-size: 5px; }
    .dest-arrived { min-height: 36px; }
    .ladder-area { height: 340px; }
    .char-label,.dest-label { font-size: 5px; }
    .game-board { padding: 12px 8px; }
  }
</style>
</head>
<body>

<div class="stars" id="stars"></div>
<div class="container">
  <div class="title-area">
    <h1>üéÆ ÏÇ¨Îã§Î¶¨ ÌÉÄÍ∏∞ üéÆ</h1>
    <div class="subtitle">‚≠ê BUBBLE BOBBLE LADDER ‚≠ê</div>
    <div class="coin-display"><span>ü™ô INSERT COIN</span><span>CREDIT: 99</span></div>
  </div>

  <div class="game-board">
    <div class="pixel-border"></div>
    <div class="row" id="charRow"></div>
    <div class="ladder-area" id="ladderArea">
      <canvas class="ladder-canvas" id="ladderCanvas"></canvas>
    </div>
    <div class="row" id="destRow"></div>
    <div class="pixel-border"></div>
  </div>

  <div class="controls">
    <button class="start-btn" id="startBtn" onclick="startRace()">
      <span class="blink">‚ñ∂</span> START <span class="blink">‚óÄ</span>
    </button>
  </div>

  <div class="result-banner" id="resultBanner">
    <h2>üèÜ ÏµúÏ¢Ö Í≤∞Í≥º üèÜ</h2>
    <div class="result-list" id="resultList"></div>
  </div>
</div>
<div class="confetti-container" id="confettiContainer"></div>

<script>
const CHARS = [
  { emoji:'üê±', name:'ÎÉ•Ïù¥', color:'#ff6b6b' },
  { emoji:'üê∂', name:'Î©çÏù¥', color:'#4ecdc4' },
  { emoji:'üê∏', name:'Í∞úÍµ¥', color:'#39ff14' },
  { emoji:'üêª', name:'Í≥∞Îèå', color:'#cd7f32' },
  { emoji:'üê∞', name:'ÌÜ†ÎÅº', color:'#ff69b4' },
  { emoji:'ü¶ä', name:'Ïó¨Ïö∞', color:'#ff8c00' },
  { emoji:'üêß', name:'Ìé≠Í∑Ñ', color:'#00bfff' },
  { emoji:'üê≤', name:'Ïö©Ïù¥', color:'#bf00ff' },
  { emoji:'ü¶Å', name:'ÏÇ¨Ïûê', color:'#ffd700' },
];
const N = 9;
let ladder = [];
let routes = [];
let raceOn = false;
let arrivedCount = 0;
let rankings = [];
let canvas, ctx, W, H, colXs;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Audio ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ac = new (window.AudioContext || window.webkitAudioContext)();
function sfx(type) {
  const t = ac.currentTime;
  const sq = (f, start, dur, vol=0.1) => {
    const o = ac.createOscillator(), g = ac.createGain();
    o.type='square'; o.frequency.value=f;
    g.gain.setValueAtTime(vol, t+start);
    g.gain.exponentialRampToValueAtTime(0.001, t+start+dur);
    o.connect(g).connect(ac.destination);
    o.start(t+start); o.stop(t+start+dur);
  };
  if (type==='start') [523,659,784,1047].forEach((f,i) => sq(f, i*0.12, 0.2, 0.11));
  if (type==='arrive') {
    [784,988,1175,1568].forEach((f,i) => sq(f, i*0.08, 0.35, 0.09));
    const o=ac.createOscillator(), g=ac.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(1200,t+0.3); o.frequency.exponentialRampToValueAtTime(600,t+0.7);
    g.gain.setValueAtTime(0.07,t+0.3); g.gain.exponentialRampToValueAtTime(0.001,t+0.7);
    o.connect(g).connect(ac.destination); o.start(t+0.3); o.stop(t+0.7);
  }
  if (type==='complete') [523,659,784,1047,784,1047,1319].forEach((f,i) => sq(f, i*0.15, 0.3, 0.09));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Stars ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
!function() {
  const c = document.getElementById('stars');
  for (let i=0;i<70;i++) {
    const s=document.createElement('div'); s.className='star';
    const sz=Math.random()*2.5+1;
    Object.assign(s.style,{width:sz+'px',height:sz+'px',left:Math.random()*100+'%',top:Math.random()*100+'%',
      animationDelay:Math.random()*2+'s',animationDuration:(Math.random()*2+1)+'s'});
    c.appendChild(s);
  }
}();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Board ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initBoard() {
  const cr=document.getElementById('charRow'), dr=document.getElementById('destRow');
  cr.innerHTML=''; dr.innerHTML='';
  CHARS.forEach((ch,i) => {
    cr.innerHTML+=`<div class="char-slot"><div class="char-label" style="color:${ch.color}">${ch.name}</div><div class="character" style="background:${ch.color}22;border:2px solid ${ch.color}">${ch.emoji}</div></div>`;
    dr.innerHTML+=`<div class="dest-slot"><div class="dest-arrived" id="da-${i}"><div class="dest-arrived-emoji"></div><div class="dest-arrived-name"></div></div><div class="dest-box" id="dest-${i}"><span class="qm">?</span><span class="rank" style="display:none"></span></div><div class="dest-label">GOAL ${i+1}</div></div>`;
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Classic Ladder Generation ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function generateLadder() {
  canvas=document.getElementById('ladderCanvas');
  const area=document.getElementById('ladderArea');
  canvas.width=area.offsetWidth; canvas.height=area.offsetHeight;
  ctx=canvas.getContext('2d');
  W=canvas.width; H=canvas.height;

  const margin = W * 0.05;
  colXs = [];
  for (let i=0;i<N;i++) colXs.push(margin + i*((W-2*margin)/(N-1)));

  // Generate rungs: guarantee every adjacent pair has at least 5 rungs
  ladder = [];
  const rows = 14;
  const yStep = H/(rows+1);
  const MIN_RUNGS = 5;

  // Step 1: random generation row by row
  for (let r=1; r<=rows; r++) {
    const y = r * yStep;
    let c = 0;
    while (c < N-1) {
      if (Math.random() < 0.5) {
        ladder.push({ c1:c, c2:c+1, y });
        c += 2;
      } else {
        c++;
      }
    }
  }

  // Step 2: count rungs per adjacent pair and fill any gaps
  for (let pair=0; pair<N-1; pair++) {
    let count = ladder.filter(r => (r.c1===pair && r.c2===pair+1) || (r.c1===pair+1 && r.c2===pair)).length;
    
    // Collect which row-y positions are already taken for this pair
    const usedYs = ladder
      .filter(r => (r.c1===pair && r.c2===pair+1) || (r.c1===pair+1 && r.c2===pair))
      .map(r => r.y);

    // Build list of available y slots for this pair
    const availableYs = [];
    for (let r=1; r<=rows; r++) {
      const y = r * yStep;
      // Check this pair doesn't already have a rung here
      const taken = usedYs.some(uy => Math.abs(uy - y) < yStep * 0.5);
      // Also check neither column is used by another rung at this y
      const colBlocked = ladder.some(rg =>
        Math.abs(rg.y - y) < yStep * 0.3 &&
        (rg.c1 === pair || rg.c2 === pair || rg.c1 === pair+1 || rg.c2 === pair+1) &&
        !(rg.c1===pair && rg.c2===pair+1)
      );
      if (!taken && !colBlocked) availableYs.push(y);
    }

    // Add rungs until we reach minimum
    let attempts = 0;
    while (count < MIN_RUNGS && attempts < 30) {
      attempts++;
      if (availableYs.length > 0) {
        const idx = Math.floor(Math.random() * availableYs.length);
        const y = availableYs.splice(idx, 1)[0];
        ladder.push({ c1:pair, c2:pair+1, y });
        count++;
      } else {
        // Force add at a slightly offset y between existing rows
        const r = Math.floor(Math.random() * rows) + 1;
        const y = r * yStep + (Math.random()-0.5) * yStep * 0.4;
        const duplicate = ladder.some(rg =>
          rg.c1===pair && rg.c2===pair+1 && Math.abs(rg.y - y) < yStep * 0.3
        );
        if (!duplicate) {
          ladder.push({ c1:pair, c2:pair+1, y });
          count++;
        }
      }
    }
  }

  // Sort all rungs by y for clean rendering
  ladder.sort((a,b) => a.y - b.y);

  drawLadder();
  computeRoutes();
}

function drawLadder() {
  ctx.clearRect(0,0,W,H);

  // Vertical rails
  colXs.forEach((x,i) => {
    ctx.save();
    ctx.strokeStyle = CHARS[i].color;
    ctx.lineWidth=8; ctx.globalAlpha=0.07;
    ctx.shadowColor=CHARS[i].color; ctx.shadowBlur=14;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.strokeStyle = CHARS[i].color;
    ctx.lineWidth=3; ctx.globalAlpha=0.65;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    ctx.restore();
  });

  // Horizontal rungs
  ladder.forEach(rung => {
    const x1=colXs[rung.c1], x2=colXs[rung.c2], y=rung.y;

    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.5)';
    ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
    ctx.restore();

    // small dots at connection
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.55)';
    [x1,x2].forEach(x => { ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
    ctx.restore();
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Compute route for each starting column ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeRoutes() {
  routes = [];
  const sortedRungs = [...ladder].sort((a,b) => a.y - b.y);

  for (let startCol=0; startCol<N; startCol++) {
    const wp = [];
    let col = startCol;
    let curY = 0;
    wp.push({x:colXs[col], y:0});

    const used = new Set();
    let found = true;
    while (found) {
      found = false;
      for (let ri=0; ri<sortedRungs.length; ri++) {
        if (used.has(ri)) continue;
        const rg = sortedRungs[ri];
        if (rg.y <= curY) continue;

        let next = -1;
        if (rg.c1===col) next=rg.c2;
        else if (rg.c2===col) next=rg.c1;
        if (next<0) continue;

        // go down to rung, then across
        wp.push({x:colXs[col], y:rg.y});
        wp.push({x:colXs[next], y:rg.y});
        col = next;
        curY = rg.y;
        used.add(ri);
        found = true;
        break;
      }
    }

    wp.push({x:colXs[col], y:H});
    routes.push({startCol, endCol:col, wp});
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Path interpolation ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function pathLen(wp) {
  let d=0;
  for (let i=1;i<wp.length;i++) d+=Math.hypot(wp[i].x-wp[i-1].x, wp[i].y-wp[i-1].y);
  return d;
}

function lerpPath(wp, t) {
  t=Math.max(0,Math.min(1,t));
  const total=pathLen(wp);
  let target=t*total;
  for (let i=1;i<wp.length;i++) {
    const seg=Math.hypot(wp[i].x-wp[i-1].x, wp[i].y-wp[i-1].y);
    if (target<=seg) {
      const f=seg===0?0:target/seg;
      return {x:wp[i-1].x+(wp[i].x-wp[i-1].x)*f, y:wp[i-1].y+(wp[i].y-wp[i-1].y)*f};
    }
    target-=seg;
  }
  return {x:wp[wp.length-1].x, y:wp[wp.length-1].y};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Draw glowing trail ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function drawTrail(wp, t, color) {
  const total=pathLen(wp);
  let target=t*total;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=6; ctx.globalAlpha=0.35;
  ctx.shadowColor=color; ctx.shadowBlur=12;
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.setLineDash([]);
  ctx.beginPath();
  ctx.moveTo(wp[0].x, wp[0].y);
  for (let i=1;i<wp.length;i++) {
    const seg=Math.hypot(wp[i].x-wp[i-1].x, wp[i].y-wp[i-1].y);
    if (target<=seg) {
      const f=seg===0?0:target/seg;
      ctx.lineTo(wp[i-1].x+(wp[i].x-wp[i-1].x)*f, wp[i-1].y+(wp[i].y-wp[i-1].y)*f);
      break;
    }
    ctx.lineTo(wp[i].x, wp[i].y);
    target-=seg;
  }
  ctx.stroke();
  ctx.restore();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Race ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function startRace() {
  if (raceOn) return;
  raceOn=true; arrivedCount=0; rankings=[];
  document.getElementById('startBtn').disabled=true;
  document.getElementById('resultBanner').classList.remove('show');

  for (let i=0;i<N;i++) {
    const b=document.getElementById(`dest-${i}`);
    b.className='dest-box';
    b.querySelector('.qm').style.display='';
    const rk=b.querySelector('.rank'); rk.style.display='none'; rk.textContent='';
    const da=document.getElementById(`da-${i}`);
    da.className='dest-arrived';
    da.querySelector('.dest-arrived-emoji').textContent='';
    da.querySelector('.dest-arrived-name').textContent='';
  }

  generateLadder();
  sfx('start');

  document.querySelectorAll('.mover').forEach(e=>e.remove());
  const area=document.getElementById('ladderArea');

  // Slower: base 9s, each +0.5s random offset
  const baseDur = 9000;
  const offsets = shuffle([...Array(N).keys()]).map(i => i*500);

  const racers = routes.map((route,i) => {
    const el=document.createElement('div');
    el.className='mover';
    el.textContent=CHARS[route.startCol].emoji;
    area.appendChild(el);
    return {el, route, duration:baseDur+offsets[i], arrived:false};
  });

  let t0=null;

  function frame(ts) {
    if (!t0) t0=ts;
    drawLadder();

    let allDone=true;

    racers.forEach(r => {
      if (r.arrived) { drawTrail(r.route.wp, 1, CHARS[r.route.startCol].color); return; }
      allDone=false;

      let t=(ts-t0)/r.duration;
      if (t>=1) {
        t=1; r.arrived=true; arrivedCount++;
        const rank=arrivedCount;
        rankings.push({ci:r.route.startCol, dc:r.route.endCol, rank});
        revealDest(r.route.endCol, rank, r.route.startCol);
        r.el.classList.add('arrived');
        sfx('arrive');

        if (arrivedCount===N)
          setTimeout(()=>{sfx('complete');showResults();confetti();raceOn=false;document.getElementById('startBtn').disabled=false;},600);
      }

      // ease in-out cubic
      const e = t<0.5 ? 4*t*t*t : 1-Math.pow(-2*t+2,3)/2;
      const pos=lerpPath(r.route.wp, e);
      r.el.style.left=(pos.x-16)+'px';
      r.el.style.top=(pos.y-16)+'px';
      drawTrail(r.route.wp, e, CHARS[r.route.startCol].color);
    });

    if (!allDone) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function revealDest(dc,rank,ci) {
  const b=document.getElementById(`dest-${dc}`);
  b.querySelector('.qm').style.display='none';
  const rk=b.querySelector('.rank'); rk.style.display=''; rk.textContent=rank;
  b.classList.add('revealed');
  if (rank<=3) b.classList.add('r'+rank);

  // Show arrived character + name above box
  const da=document.getElementById(`da-${dc}`);
  da.querySelector('.dest-arrived-emoji').textContent=CHARS[ci].emoji;
  const nameEl=da.querySelector('.dest-arrived-name');
  nameEl.textContent=CHARS[ci].name;
  nameEl.style.color=CHARS[ci].color;
  da.classList.add('show');
}

function showResults() {
  const banner=document.getElementById('resultBanner');
  const list=document.getElementById('resultList');
  list.innerHTML='';
  const medals=['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£'];
  rankings.sort((a,b)=>a.rank-b.rank).forEach(r=>{
    list.innerHTML+=`<div class="result-item"><span class="medal">${medals[r.rank-1]}</span><span>${CHARS[r.ci].emoji} ${CHARS[r.ci].name}</span></div>`;
  });
  banner.classList.add('show');
}

function confetti() {
  const c=document.getElementById('confettiContainer'); c.innerHTML='';
  const cols=['#ff2d95','#00f0ff','#ffe600','#39ff14','#ff6b00','#bf00ff'];
  for (let i=0;i<55;i++) {
    const p=document.createElement('div'); p.className='confetti-piece';
    Object.assign(p.style,{left:Math.random()*100+'%',background:cols[~~(Math.random()*cols.length)],
      width:(Math.random()*8+5)+'px',height:(Math.random()*8+5)+'px',
      borderRadius:Math.random()>0.5?'50%':'2px',
      animationDuration:(Math.random()*2+2)+'s',animationDelay:Math.random()*1.5+'s'});
    c.appendChild(p);
  }
  setTimeout(()=>c.innerHTML='',5000);
}

let resizeTimer;
window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>{if(!raceOn)generateLadder();},200);});

initBoard();
setTimeout(()=>generateLadder(),100);
</script>
</body>
</html>
